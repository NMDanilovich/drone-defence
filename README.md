drone-defence
=

## Описание

Проект посвящен противодействию дронам в небе.

## Структура проекта

```
drone_defence/
├── app/
│   ├── camera_control/
│   │    ├── configs/     # Дир. с файлами конфигурации
│   │    ├── sorces/      # Дир. с исходниками
│   ├── calibration.py    # Скрипт для калибровки камер
│   ├── overview.py       # Модуль обзорных камер
│   ├── tracker.py        # Модуль трекера
│   └── start_point.py    # Точка запуска процессов
├── requirements.txt      # Зависимости Python
├── README.md             # Документация проекта
└── .gitignore            # Файлы и директории, игнорируемые Git
```

Дирректория `configs` содержжит следующие конфигурационные файлы:

1) carriage.conf:
```ini
[CARRIAGE]
start_x_position = 0           # Старотовая позиция лафета    
start_y_position = 119       
last_x_position = 0            # Последняя позиция
last_y_position = 119
max_x_coord = 8000             # Лимиты на координаты X и Y
min_x_coord = -8000
max_y_coord = 145
min_y_coord = 50
baudrate = 115200              # настройки посл. порта
serial_port = /dev/ttyTHS0
```
2) connactions.conf:
```ini
[OV_CAMERA_1]   # Обзорные камеры начинаются с OV_*
ip = ip
port = port
login = login
password = 123

...

[T_CAMERA_1]   # Камера для трекинга начинается с T_*
ip = ip
port = port
login = login
password = 123
```

3) overview.conf

```ini
[OVERVEIW]
width_frame = 1920      # характеристики камеры
height_frame = 1080
horiz_angle = 110
vertic_angle = 60
horizont = 119          # горизонт по умолчанию
model_path = "../models/11s_1024.pt"  # настройки модели
drone_class_id = 1
detector_conf = 0.55
detector_iou = 0.7
```

4) tracking.conf
```ini
[TRACKING]
width_frame = 1920      # характеристики камеры
height_frame = 1080
horiz_angle = 110
vertic_angle = 60
model_path = "../models/11s_1024.pt"  # настройки модели
detector_conf = 0.55
detector_iou = 0.7
drone_class_id = 1
stop_are_scale = 0.2        # размер зоны попадения дрона
simularity_threshold = 0.7  # порог для сравнения дискрипторов (эмбедингов)
```

## Использование

Перед запуском проекта настоятельно рекомендую ознакомиться с дирректорией configs, где лежат файлы конфигурации и провести калибровку обзорных камер.

Для запуска проекта используйте скрипт 

```bash
cd drone_defence/app/camera_control
python3 start_point.py
```

Скрипт запускает два процесса: `tracker` и `overview`.

## Методика калибровки 
Перед запуском процесса в overview.py необходимо провести калибровку обзорных камер. Это нужно сделать для корректного наведения платформы на искомый объект. Калибровка привязывает систему координат нижнего двигателя к положению камер.

### Ручная калибровка
Для проведения ручной калибровки перейдите в директорию с скриптом калибровки данном репозитории

```bash
cd drone_defence/app/camera_controll
```

В директории app/camera_control/configs лежит шаблон конфигурационного файла калибровки calibration.conf. Для удобства откройте его в соседнем окне vscode командой 

```bash
code app/camera_control/configs/calibration.conf
```

Или в соседнем окне терминала

```bash
nano app/camera_control/configs/calibration.conf
```

Шаблон имеет структуру

```ini
[CALIBRATION]
camera_1 = 0
...
camera_N = 9999
```

Сколько камер стоит в обзорной части, столько и строк должно быть. На место чисел, указанных по умолчанию, необходимо будет подставить калибровочные значения.

Для получения калибровочных значений перейдите к скрипту calibration.py и запустите команду для получения информации по использованию

```bash
python3 calibration.py --help
```

> Примечание:
> Для установки платформы в стартовое положения используйте флаг 
> ```bash
> python3 calibration.py --start
> ```
> Для изменения положения установки по оси X (рысканье) используйте 
> ```bash
> python3 calibration.py --x N
> ```
> Для изменения положения установки по оси Y (тангаж) используйте
> ```bash
> python3 calibration.py --y N
> ```
> Где N - любое целочисленное значение. Для обоих флагов N по умолчанию равно 0. Для изменения положения используются относительные координаты (предыдущее положение + N).

Для удобства, откройте камеры с помощью веб интерфейса или иной программы для просмотра видеопотока с обзорных камер.

Далее необходимо провести ручную калибровку.
Алгоритм калибровки:
1) Перевести платформу в стартовое положение.
2) Установить метку в положение видным для камер. В отсутствие меток, воспользуйтесь крайним нижним положением ствола установки. Для этого измените координату по оси Y установки.
3) Выбрать ближайшую к стартовому положению камеру. Определить, какой по счету является камера (с помощью файла конфигурации подключений app/camera_control/configs/connactions.conf)
4) С помощью изменения координаты X установить метку по середине кадра выбранной камеры. 
5) Внести последний зафиксированный в терминале результат по оси X в файл конфигурации.
6) Повторить шаги 4-5 для оставшихся камер.
> Примечание: необходимо проводить калибровку таким образом, чтобы половина координат была определена с положительным знаком, а половина с отрицательным.

## Контакты